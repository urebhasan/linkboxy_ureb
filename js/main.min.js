$(function() {
    if (localStorage.section != null && firstSignIn == !1) {
        showSection(localStorage.section)
    } else if (firstSignIn == !0) {
        showSection('profile')
    }
    $('[data-toggle="tooltip"]').tooltip();

    function showSection(section) {
        if (section == 'websites') {
            $('.main-area-websites').show();
            showLoading();
            updateWebsites()
        } else {
            $('.main-area-websites').hide()
        }
        if (section == 'backlinks') {
            $('.main-area-backlinks').show();
            showLoading();
            updateBacklinks()
        } else {
            $('.main-area-backlinks').hide()
        }
        if (section == 'profile') {
            $('.main-area-profile').show();
            showLoading();
            updateProfile()
        } else {
            $('.main-area-profile').hide()
        }
        localStorage.section = section
    }

    function showLoading() {
        $('.loading').remove();
        $('.main-area').append('<div class="loading"></div>')
    }

    function hideLoading() {
        $('.loading').remove()
    }
	$( ".main-area-websites" ).on( "click",'.showBacklinks', function() {
			$('.main-area-websites').hide();
		    $('#manageWebsites').removeClass('active');
		    $('#manageBacklinks').addClass('active');
		    $('.main-area-backlinks').show();
            showLoading();
            updateBacklinks($(this).data('id'))
	});

    function updateWebsites() {
        $.ajax({
            url: "ajax/domains.php",
            type: "GET",
            dataType: "json",
            error: function() {
                alert('Error')
            },
            beforeSend: function() {},
            success: function(data) {
                if (data.success === !0) {
                    if (data.count == 0) {
                        $('.content:visible').html('<br>You have not added any websites yet, please add your first site then some backlinks to monitor.')
                    } else {
                        var imported = document.createElement('script');
                        imported.src = 'js/jquery.dataTables.min.js';
                        imported.src = 'js/backlink.js';
                        document.head.appendChild(imported);
                        $('.content:visible').html('<table id="domain-list" class="table table-striped tab-list-table domain-list-table websites-list"><thead class="table-head"><tr><th><span>Domain</span></th><th><span>Backlinks URL</span></th><th><span>Action</span></th></tr></thead><tbody></tbody></table>');
                        $.each(data.websites, function(k, v) {
                            url = v.domain;
                            nofollow = (v.nofollow != 0 ? '<span data-toggle="tooltip" data-placement="top" title="Backlinks found, but has nofollow attribute" style="color: #dddddd;"><img src="images/status.png" class="status-icon" alt="status"></span> ' + v.nofollow + ' / ' : '');
                            count = '<span data-toggle="tooltip" data-placement="top" title="Backlinks found" style="color: #2ecc40;"><img src="images/status.png" class="status-icon" alt="status"></span> ' + (v.checked - v.nofollow) + ' / ' + nofollow + '<span data-toggle="tooltip" data-placement="top" title="Backlinks not found" style="color: #ff4136;"><img src="images/follow.png" class="follow-icon" alt="follow"></span> ' + v.failed + ' / <span data-toggle="tooltip" data-placement="top" title="In progress" style="color: #dddddd;"><img src="images/link-load.png" class="load-icon" alt="follow"></span> ' + v.unchecked;
                            $('.websites-list > tbody:last-child').append('<tr data-id="' + v.id + '"><th scope="row"><a href="#" data-id="' + v.id + '" class="showBacklinks">' + url + '</a></th><td>' + count + '</td><td><span class="deleteDomain" data-id="' + v.id + '" data-toggle="tooltip" data-placement="top" title="Delete" style="cursor: pointer; color: #7fdbff;"><img src="images/delete.png" class="delete-icon" alt="delete"></span></td></tr>')
                        });
                        $('[data-toggle="tooltip"]').tooltip()
                    }
                } else if (data.error === !0) {
                    $.notify({
                        message: data.text
                    }, {
                        placement: {
                            from: 'bottom',
                            align: 'center'
                        },
                        type: 'danger'
                    })
                }
            },
            complete: function() {
                hideLoading()
            }
        })
    }

    function updateProfile() {
        $.ajax({
            url: "ajax/profileInfo.php",
            type: "GET",
            dataType: "json",
            error: function() {
                alert('Error')
            },
            beforeSend: function() {},
            success: function(data) {
                if (data.success === !0) {
                    $('#profileEmail').text(data.email);
                    $('#profileName').text(data.name);
                    $('#profileIp').text(data.ip);
                    $('#profileBacklinks').text(data.backlinks);
                    $('#profileWebsites').text(data.websites)
                } else if (data.error === !0) {
                    $.notify({
                        message: data.text
                    }, {
                        placement: {
                            from: 'bottom',
                            align: 'center'
                        },
                        type: 'danger'
                    })
                }
            },
            complete: function() {
                hideLoading()
            }
        })
    }

    function updateBacklinks(id=false) {
		var appendUrl = id ? '?domain='+id : '';
        $.ajax({
            url: "ajax/backlinks.php"+appendUrl,
            type: "GET",
            dataType: "json",
            error: function(data) {
                alert('Error')
            },
            beforeSend: function() {},
            success: function(data) {
                if (data.success === !0) {
                    if (data.count == 0) {
                        $('.content:visible').html('<br>No backlinks yet.')
                    } else {
                        var imported = document.createElement('script');
                        imported.src = 'js/jquery.dataTables.min.js';
                        imported.src = 'js/backlink.js';
                        document.head.appendChild(imported);
                        $('.content:visible').html('<table id="backlink-list" class="table table-striped tab-list-table backlink-list tab-list-table backlinks-list"><thead class="table-head"><tr><th class="link-heading"><span>Backlinks URL</span></th><th><span>Domain</span></th><th><span>Anchor text</span></th><th class="text-center"><span>Status</span></th><th class="text-center"><span>Follow</span></th><th><span class="text-center">Checked at <span data-toggle="tooltip" data-placement="top" title="" style="color: #FFDC00;" data-original-title="Europe/London time"><i class="fa fa-question-circle"></i></span></span></th><th class="text-center"><span class="text-center">Action</span></th></tr></thead><tbody></tbody></table>');
                        currentParentId = null;
                        $.each(data.backlinks, function(k, v) {
                            url = v.url;
                            anchor = (v.anchor != null ? v.anchor : '');
                            updated = (v.updated != null ? v.updated : 'not yet');
                            color = (v.nofollow == null ? '#2ecc40' : '#dddddd');
                            tooltip = (v.nofollow == null ? 'Backlink found!' : 'Backlink found but has nofollow attribute!');
                            statusArray = ['<span data-toggle="tooltip" data-placement="top" title="Just added. Info will be later." style="color: #dddddd;"><img src="images/link-load.png" class="load-icon" alt="follow"></span>', '<span data-toggle="tooltip" data-placement="top" title="' + tooltip + '" style="color: ' + color + ';"><img src="images/status.png" class="status-icon" alt="status"></span>', '<span data-toggle="tooltip" data-placement="top" title="Backlink not found!" style="color: #ff4136;"><img src="images/follow.png" class="follow-icon" alt="follow"></span>']
                            status = statusArray[v.status];
                            if (v.status == 0) {
                                follow = '<span data-toggle="tooltip" data-placement="top" title="Just added. Info will be later." style="color: #dddddd;"><img src="images/link-load.png" class="load-icon" alt="follow"></span>'
                            } else if (v.status == 2) {
                                follow = '<span data-toggle="tooltip" data-placement="top" title="No backlink found" style="color: #ff4136;"><img src="images/follow.png" class="follow-icon" alt="follow"></span>'
                            } else if (v.nofollow == null) {
                                follow = '<span data-toggle="tooltip" data-placement="top" title="Link follow OK." style="color: #2ecc40;"><img src="images/status.png" class="status-icon" alt="status"></span>'
                            } else if (v.nofollow == 1) {
                                follow = '<span data-toggle="tooltip" data-placement="top" title="Link has nofollow attribute" style="color: #ff4136;"><img src="images/follow.png" class="follow-icon" alt="follow"></span>'
                            }
                            if (currentParentId != v.id) {
                                status_icon = '';
                                if (v.backlink_status == 0) {
                                    status_icon = '<span data-toggle="tooltip" data-placement="top" title="Backlink just added. Info will be later." style="color: #dddddd;"><img src="images/link-load.png" class="load-icon" alt="follow"></span>'
                                } else if (v.backlink_status == 2) {
                                    status_icon = '<span data-toggle="tooltip" data-placement="top" title="No backlinks found on this page" style="color: #ff4136;"><img src="images/follow.png" class="follow-icon" alt="follow"></span>'
                                }
                                if (v.backlinks_link_id == null) {
                                    icon = ''
                                } else {
                                    icon = '<span data-toggle="tooltip" data-placement="top" title="URLs found on this backlink" style="color: #51ec00;"><img src="images/download.png" class="link-download" alt="download"></span> '
                                }
                                $('.backlinks-list > tbody:last-child').append('<tr data-id="' + v.id + '"><th>' + icon + url + '</th><th>' + v.domain + '</th><th></th><th class="text-center">' + status_icon + '</th><th class="text-center"></th><th class="text-center"></th><th class="text-center"><span class="deleteBacklinkParent" data-id="' + v.id + '" data-toggle="tooltip" data-placement="top" title="Delete backlink" style="cursor: pointer; color: #7fdbff;"><img src="images/delete.png" class="delete-icon" alt="delete"></span></th></tr>')
                            }
                            if (v.backlink_status != 0 && v.backlink_status != 2 && v.backlinks_link_id != null) {
                                $('.backlinks-list > tbody:last-child').append('<tr data-id="' + v.id + '" data-backlink-id="' + v.backlinks_link_id + '"><th scope="row"><a class="listLink" href="' + v.backlink_url + '" target="_blank">' + v.backlink_url + '</a></th><th scope="row"></th><td>' + anchor + '</td><td class="text-center">' + status + '</td><td class="text-center">' + follow + '</td><td>' + updated + '</td><td class="text-center"><span class="deleteBacklink" data-id="' + v.backlinks_link_id + '" data-toggle="tooltip" data-placement="top" title="Delete" style="cursor: pointer; color: #7fdbff;"><img src="images/delete.png" class="delete-icon" alt="delete"></span></td></tr>')
                            }
                            currentParentId = v.id
                        });
                        $('[data-toggle="tooltip"]').tooltip()
                    }
                    $('#backlinksWebsite').empty();
                    if (data.sites.length == 0) {
                        $('#backlinksWebsite').append('<option value="">Add domain first...</option>')
                    } else {
                        $.each(data.sites, function(k, v) {
                            $('#backlinksWebsite').append('<option value="' + v.id + '">' + v.url + '</option>')
                        })
                    }
                } else if (data.error === !0) {
                    $.notify({
                        message: data.text
                    }, {
                        placement: {
                            from: 'bottom',
                            align: 'center'
                        },
                        type: 'danger'
                    })
                }
            },
            complete: function() {
                hideLoading()
            }
        })
    }
    $(document).on('click', '.deleteDomain', function(e) {
        id = $(this).data('id');
        tr = $(this).closest('tr');
        $.ajax({
            url: "ajax/domainDelete.php",
            type: "POST",
            data: 'id=' + id,
            dataType: "json",
            error: function() {
                alert('Error')
            },
            beforeSend: function() {},
            success: function(data) {
                if (data.success === !0) {
                    $.notify({
                        message: data.text
                    }, {
                        placement: {
                            from: 'bottom',
                            align: 'center'
                        },
                        type: 'success',
                        z_index: 2000
                    });
                    tr.remove();
                    $('.tooltip').tooltip('hide')
                } else if (data.error === !0) {
                    $.notify({
                        message: data.text
                    }, {
                        placement: {
                            from: 'bottom',
                            align: 'center'
                        },
                        type: 'danger',
                        z_index: 2000
                    })
                }
            },
            complete: function() {}
        })
    });
    $(document).on('click', '.deleteBacklinkParent', function(e) {
        id = $(this).data('id');
        tr = $('tr[data-id="' + id + '"]');
        $.ajax({
            url: "ajax/backlinksTreeDelete.php",
            type: "POST",
            data: 'id=' + id,
            dataType: "json",
            error: function() {
                alert('Error')
            },
            beforeSend: function() {},
            success: function(data) {
                if (data.success === !0) {
                    $.notify({
                        message: data.text
                    }, {
                        placement: {
                            from: 'bottom',
                            align: 'center'
                        },
                        type: 'success',
                        z_index: 2000
                    });
                    tr.remove();
                    $('.tooltip').tooltip('hide')
                } else if (data.error === !0) {
                    $.notify({
                        message: data.text
                    }, {
                        placement: {
                            from: 'bottom',
                            align: 'center'
                        },
                        type: 'danger',
                        z_index: 2000
                    })
                }
            },
            complete: function() {}
        })
    });
    $(document).on('click', '.deleteBacklink', function(e) {
        id = $(this).data('id');
        tr = $(this).closest('tr');
        $.ajax({
            url: "ajax/backlinksDelete.php",
            type: "POST",
            data: 'id=' + id,
            dataType: "json",
            error: function() {
                alert('Error')
            },
            beforeSend: function() {},
            success: function(data) {
                if (data.success === !0) {
                    $.notify({
                        message: data.text
                    }, {
                        placement: {
                            from: 'bottom',
                            align: 'center'
                        },
                        type: 'success',
                        z_index: 2000
                    });
                    tr.remove();
                    $('.tooltip').tooltip('hide')
                } else if (data.error === !0) {
                    $.notify({
                        message: data.text
                    }, {
                        placement: {
                            from: 'bottom',
                            align: 'center'
                        },
                        type: 'danger',
                        z_index: 2000
                    })
                }
            },
            complete: function() {}
        })
    });
    $('#addBacklinks').on('click', function(e) {
        $('#backlinksValue').val('')
    });
    $('#addDomain').on('click', function(e) {
        domain = $('#domainToAdd').val();
        $.ajax({
            url: "ajax/domainAdd.php",
            type: "POST",
            data: 'domain=' + domain,
            dataType: "json",
            error: function() {
                alert('Error')
            },
            beforeSend: function() {},
            success: function(data) {
                if (data.success === !0) {
                    $.notify({
                        message: data.text
                    }, {
                        placement: {
                            from: 'bottom',
                            align: 'center'
                        },
                        type: 'success',
                        z_index: 2000
                    });
                    updateWebsites()
                } else if (data.error === !0) {
                    $.notify({
                        message: data.text
                    }, {
                        placement: {
                            from: 'bottom',
                            align: 'center'
                        },
                        type: 'danger',
                        z_index: 2000
                    })
                }
            },
            complete: function() {
                hideLoading()
            }
        })
    });
    $('#saveBacklinks').on('click', function(e) {
        domain = $('#backlinksWebsite').val();
        backlinks = $('#backlinksValue').val();
        $.ajax({
            url: "ajax/backlinksAdd.php",
            type: "POST",
            data: 'domain=' + domain + '&backlinks=' + backlinks,
            dataType: "json",
            error: function() {
                alert('Error jii')
            },
            beforeSend: function() {},
            success: function(data) {
                if (data.success === !0) {
                    $.notify({
                        message: data.text
                    }, {
                        placement: {
                            from: 'bottom',
                            align: 'center'
                        },
                        type: 'success',
                        z_index: 2000
                    });
                    updateBacklinks()
                } else if (data.error === !0) {
                    $.notify({
                        message: data.text
                    }, {
                        placement: {
                            from: 'bottom',
                            align: 'center'
                        },
                        type: 'danger',
                        z_index: 2000
                    })
                }
            },
            complete: function() {
                hideLoading()
            }
        })
    });
    $('#manageWebsites').on('click', function(e) {
        $('#manageWebsites').addClass('active')
        $('#manageBacklinks').removeClass('active')
        $('#profileInfo').removeClass('active')
        showSection('websites')
    });
    $('#manageBacklinks').on('click', function(e) {
        $('#manageBacklinks').addClass('active')
        $('#manageWebsites').removeClass('active')
        $('#profileInfo').removeClass('active')
        showSection('backlinks')
    });
    $('#profileInfo').on('click', function(e) {
        $('#profileInfo').addClass('active')
        $('#manageWebsites').removeClass('active')
        $('#manageBacklinks').removeClass('active')
        showSection('profile')
    });
    $('#signOut').on('click', function(e) {
        $.ajax({
            url: "ajax/signOut.php",
            type: "POST",
            data: 'yes=yes',
            dataType: "json",
            error: function() {
                alert('Error')
            },
            beforeSend: function() {},
            success: function(data) {
                if (data.success === !0) {
                    $.notify({
                        message: data.text
                    }, {
                        placement: {
                            from: 'bottom',
                            align: 'center'
                        },
                        type: 'info'
                    });
                    setTimeout(function() {
                        window.location.href = "index.php"
                    }, 500)
                } else if (data.error === !0) {
                    $.notify({
                        message: data.text
                    }, {
                        placement: {
                            from: 'bottom',
                            align: 'center'
                        },
                        type: 'danger'
                    })
                }
            },
            complete: function() {}
        })
    });
    $('#changePasswordForm').on('submit', function(e) {
        e.preventDefault();
        oldP = $('#oldP').val();
        newP = $('#newP').val();
        newPRepeat = $('#newPRepeat').val();
        var request = $.ajax({
            url: "ajax/passwordChange.php",
            type: "POST",
            data: 'oldP=' + oldP + '&newP=' + newP + '&newPRepeat=' + newPRepeat,
            dataType: "json",
            error: function() {
                alert('Error')
            },
            beforeSend: function() {},
            success: function(data) {
                if (data.success === !0) {
                    $.notify({
                        message: data.text
                    }, {
                        placement: {
                            from: 'bottom',
                            align: 'center'
                        },
                        type: 'info'
                    })
                } else if (data.error === !0) {
                    $.notify({
                        message: data.text
                    }, {
                        placement: {
                            from: 'bottom',
                            align: 'center'
                        },
                        type: 'danger'
                    })
                }
            },
            complete: function() {}
        })
    })
})